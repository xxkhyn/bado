{% load static %}
{% load socialaccount %}

<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}bado{% endblock %}</title>
  <meta name="theme-color" content="#0f172a">
  <link rel="stylesheet" href="{% static 'css/style.css' %}?v=6">
  {% block head_extra %}{% endblock %}
</head>

<body>
  <header class="topbar">
    <div class="brand">bado</div>

    <nav class="tabs" aria-label="Primary">
      <a class="tab {% if request.resolver_match.url_name == 'calendar' or request.resolver_match.url_name == 'home' %}active{% endif %}"
        href="{% url 'calendar' %}">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
      <a class="tab {% if request.resolver_match.url_name == 'magazines_list' %}active{% endif %}"
        href="{% url 'magazines_list' %}">ğŸ“– æœˆåˆŠèªŒ</a>
    </nav>

    <div class="right">
      {% if user.is_authenticated %}
      {% with sa=user.socialaccount_set.first %}
      {% if sa and sa.get_avatar_url %}
      {% with avatar_url=sa.get_avatar_url %}
      <button id="avatarBtn" class="avatar-btn" aria-haspopup="menu" aria-expanded="false">
        <img class="avatar-img" src="{{ avatar_url }}" alt="avatar">
        <span style="font-size:0.85rem; opacity:.9;">{{ user.first_name|default:user.username }}</span>
      </button>
      {% endwith %}
      {% else %}
      <button id="avatarBtn" class="avatar-btn" aria-haspopup="menu" aria-expanded="false">
        <div class="avatar-fallback">{{ user.username|first|upper }}</div>
        <span style="font-size:0.85rem; opacity:.9;">{{ user.username }}</span>
      </button>
      {% endif %}
      {% endwith %}

      <nav id="userMenu" class="menu" role="menu">
        <div class="hdr">{{ user.email }}</div>
        <a href="{% url 'mypage' %}" role="menuitem">ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
        <a href="{% url 'calendar' %}" role="menuitem">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
        <a href="{% url 'magazines_list' %}" role="menuitem">æœˆåˆŠèªŒ</a>
        <a href="/accounts/email/" role="menuitem">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</a>
        <a href="/accounts/logout/" role="menuitem">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
      </nav>
      {% else %}
      <a class="login-btn" href="{% provider_login_url 'google' %}">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</a>
      {% endif %}
    </div>
  </header>

  <div class="wrap">
    {% block content %}{% endblock %}
  </div>

  <!-- Mobile Navigation (Visible only on small screens) -->
  <nav class="mobile-nav">
    <a href="{% url 'calendar' %}"
      class="{% if request.resolver_match.url_name == 'calendar' or request.resolver_match.url_name == 'home' %}active{% endif %}">
      <span>ğŸ“…</span>
      <span>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
    </a>
    <a href="{% url 'magazines_list' %}"
      class="{% if request.resolver_match.url_name == 'magazines_list' %}active{% endif %}">
      <span>ğŸ“–</span>
      <span>æœˆåˆŠèªŒ</span>
    </a>
    {% if user.is_authenticated %}
    <a href="{% url 'mypage' %}" class="{% if request.resolver_match.url_name == 'mypage' %}active{% endif %}">
      <span>ğŸ‘¤</span>
      <span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
    </a>
    {% else %}
    <a href="{% provider_login_url 'google' %}">
      <span>ğŸ”‘</span>
      <span>ãƒ­ã‚°ã‚¤ãƒ³</span>
    </a>
    {% endif %}
  </nav>

  <script>
    // avatar dropdown
    const btn = document.getElementById('avatarBtn');
    const menu = document.getElementById('userMenu');
    if (btn && menu) {
      const toggle = () => {
        const open = menu.style.display === 'block';
        menu.style.display = open ? 'none' : 'block';
        btn.setAttribute('aria-expanded', (!open).toString());
      };
      btn.addEventListener('click', (e) => { e.stopPropagation(); toggle(); });
      menu.addEventListener('click', (e) => e.stopPropagation());
      document.addEventListener('click', () => { if (menu.style.display === 'block') { menu.style.display = 'none'; btn.setAttribute('aria-expanded', 'false'); } });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { menu.style.display = 'none'; btn.setAttribute('aria-expanded', 'false'); } });
    }

    // Mobile menu trigger (re-use the desktop menu for now, or just scroll to top)
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    if (mobileMenuBtn && btn) {
      mobileMenuBtn.addEventListener('click', (e) => {
        e.preventDefault();
        btn.click(); // Simulate click on desktop avatar button to open menu
      });
    }
  </script>
  {% block body_end %}{% endblock %}
</body>

</html>