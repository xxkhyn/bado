{% extends "base.html" %}
{% load custom_filters %}

{% block title %}{{ year }}年{{ month }}月の予定{% endblock %}

{% block content %}
<!-- Configuration Data -->
<div id="cfg" data-year="{{ year }}" data-month="{{ month }}"></div>

<!-- Calendar Container -->
<div class="cal-container">
  <!-- Header / Navigation -->
  <div class="cal-header">
    <div class="cal-nav">
      <a href="?y={{ prev_y }}&m={{ prev_m }}">← 前の月</a>
    </div>
    <h2 style="margin:0; font-size:1.2rem; color:var(--text-main);">{{ year }}年 {{ month }}月</h2>
    <div class="cal-nav">
      <a href="?y={{ next_y }}&m={{ next_m }}">次の月 →</a>
    </div>
  </div>

  <div
    style="padding:10px 20px; display:flex; justify-content:flex-end; background:var(--bg-surface); border-bottom:1px solid var(--border-subtle);">
    <button class="btn" id="addTodayBtn" style="font-size:0.8rem; padding:6px 12px;">+ 今日に追加</button>
  </div>

  <!-- Calendar Grid -->
  <div class="cal-grid">
    <!-- Day Headers -->
    <div class="cal-head-cell" style="color:#ef4444;">日</div>
    <div class="cal-head-cell">月</div>
    <div class="cal-head-cell">火</div>
    <div class="cal-head-cell">水</div>
    <div class="cal-head-cell">木</div>
    <div class="cal-head-cell">金</div>
    <div class="cal-head-cell" style="color:#3b82f6;">土</div>

    <!-- Days -->
    {% for week in weeks %}
    {% for day in week %}
    <div class="cal-cell {% if day == today %}today{% endif %} {% if day.month != month %}other-month{% endif %}"
      data-date="{{ day|date:'Y-m-d' }}">

      <div class="day-number">{{ day.day }}</div>

      {% for e in events_by_date|get_item:day %}
      <div class="event-chip" title="{{ e.description|default_if_none:'' }}" data-id="{{ e.id }}"
        data-title="{{ e.title|escape }}" data-start="{{ e.start|date:'c' }}"
        data-end="{% if e.end %}{{ e.end|date:'c' }}{% endif %}"
        data-desc="{{ e.description|default_if_none:''|escape }}"
        data-can-manage="{% if request.user.is_staff or e.user_id == request.user.id %}1{% else %}0{% endif %}">
        <div class="event-time">{{ e|time_range }}</div>
        <div class="event-title">{{ e.title }}</div>
      </div>
      {% endfor %}
    </div>
    {% endfor %}
    {% endfor %}
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBg">
  <div class="modal">
    <h3 id="modalTitle">予定を追加</h3>

    <div class="field">
      <label>タイトル</label>
      <input type="text" id="fTitle" placeholder="例: ミーティング" />
    </div>

    <div style="display:flex; gap:16px;">
      <div class="field" style="flex:1;">
        <label>日</label>
        <select id="fDay"></select>
      </div>
      <div class="field" style="flex:1;">
        <label>開始</label>
        <input type="time" id="fStartTime" step="300" />
      </div>
      <div class="field" style="flex:1;">
        <label>終了 (任意)</label>
        <input type="time" id="fEndTime" step="300" />
      </div>
    </div>

    <div class="field">
      <label>メモ</label>
      <textarea id="fDesc" rows="3" placeholder="詳細を入力..."></textarea>
    </div>

    <!-- Attendance -->
    <div id="attendBox"
      style="border-top:1px solid var(--border-default); margin-top:16px; padding-top:16px; display:none;">
      <div style="font-size:0.85rem; color:var(--text-muted); margin-bottom:8px;">参加状況</div>
      <div style="display:flex; align-items:center; gap:12px;">
        <button id="attendBtn" class="btn">参加する</button>
        <span id="attendCount" style="font-size:0.85rem; color:var(--text-dim);"></span>
      </div>
      <div id="attendList"
        style="margin-top:8px; font-size:0.8rem; color:var(--text-muted); max-height:100px; overflow-y:auto;"></div>
    </div>

    <!-- QR Code -->
    <div id="qrBox"
      style="border-top:1px solid var(--border-default); margin-top:16px; padding-top:16px; display:none;">
      <div style="font-size:0.85rem; color:var(--text-muted); margin-bottom:8px;">出席管理</div>
      <button class="btn gray" id="showQrBtn" style="font-size:0.8rem;">QRコードを表示</button>
      <div id="qrImageWrapper" style="margin-top:12px; text-align:center; display:none;">
        <img id="qrImage" src="" alt="QR Code"
          style="width:180px; height:180px; border-radius:8px; border:1px solid var(--border-default); background:white; padding:8px;">
        <p style="font-size:0.75rem; color:var(--text-muted); margin-top:8px;">参加者にこのQRコードを読み取ってもらってください。</p>
      </div>
    </div>

    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:24px;">
      <button class="btn gray" id="cancelBtn">キャンセル</button>
      <button class="btn red" id="deleteBtn" style="display:none;">削除</button>
      <button class="btn" id="saveBtn">保存</button>
    </div>
  </div>
</div>

<script>
  // ===== CSRF =====
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  // ===== Config =====
  const cfg = document.getElementById('cfg');
  const CAL_YEAR = parseInt(cfg.dataset.year, 10);
  const CAL_MONTH = parseInt(cfg.dataset.month, 10);
  const DAYS_IN_MONTH = new Date(CAL_YEAR, CAL_MONTH, 0).getDate();

  // ===== Elements =====
  const modalBg = document.getElementById('modalBg');
  const fTitle = document.getElementById('fTitle');
  const fDay = document.getElementById('fDay');
  const fStartTime = document.getElementById('fStartTime');
  const fEndTime = document.getElementById('fEndTime');
  const fDesc = document.getElementById('fDesc');
  const saveBtn = document.getElementById('saveBtn');
  const delBtn = document.getElementById('deleteBtn');
  const modalTitle = document.getElementById('modalTitle');

  const attendBox = document.getElementById('attendBox');
  const attendBtn = document.getElementById('attendBtn');
  const attendCount = document.getElementById('attendCount');
  const attendList = document.getElementById('attendList');

  const qrBox = document.getElementById('qrBox');
  const showQrBtn = document.getElementById('showQrBtn');
  const qrImageWrapper = document.getElementById('qrImageWrapper');
  const qrImage = document.getElementById('qrImage');

  // ===== Init Day Options =====
  (function initDayOptions() {
    fDay.innerHTML = '';
    for (let d = 1; d <= DAYS_IN_MONTH; d++) {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = `${d}日`;
      fDay.appendChild(opt);
    }
  })();

  // ===== Utils =====
  const pad = (n) => String(n).padStart(2, '0');

  function localPartsToISO(day, time) {
    if (!day || !time) return null;
    const [hh, mm] = time.split(':').map(Number);
    const dt = new Date(CAL_YEAR, CAL_MONTH - 1, Number(day), hh, mm, 0);
    return dt.toISOString();
  }

  function isoToDay(iso) { if (!iso) return ''; const d = new Date(iso); return d.getDate(); }
  function isoToTime(iso) { if (!iso) return ''; const d = new Date(iso); return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }

  // ===== Modal Logic =====
  let editingId = null;
  let currentCanManage = false;

  function openModal(payload) {
    modalBg.style.display = 'flex';
    if (payload && payload.id) {
      editingId = payload.id;
      currentCanManage = !!payload.canManage;

      modalTitle.textContent = '予定を編集';
      fTitle.value = payload.title || '';
      fDay.value = isoToDay(payload.start) || 1;
      fStartTime.value = isoToTime(payload.start) || '09:00';
      fEndTime.value = isoToTime(payload.end) || '';
      fDesc.value = payload.description || '';
      delBtn.style.display = 'inline-block';

      attendBox.style.display = 'block';
      loadAttendance(editingId);

      if (currentCanManage) {
        qrBox.style.display = 'block';
      } else {
        qrBox.style.display = 'none';
      }
      qrImageWrapper.style.display = 'none';
      qrImage.src = '';

    } else {
      editingId = null;
      currentCanManage = false;

      modalTitle.textContent = '予定を追加';
      fTitle.value = '';
      fDay.value = 1;
      fStartTime.value = '09:00';
      fEndTime.value = '';
      fDesc.value = '';
      delBtn.style.display = 'none';

      attendBox.style.display = 'none';
      attendCount.textContent = '';
      attendList.textContent = '';

      qrBox.style.display = 'none';
      qrImageWrapper.style.display = 'none';
      qrImage.src = '';
    }
  }

  function closeModal() { modalBg.style.display = 'none'; }
  document.getElementById('cancelBtn').onclick = closeModal;

  // Close on backdrop click
  modalBg.addEventListener('click', (e) => {
    if (e.target === modalBg) closeModal();
  });

  // Cell Click -> New
  document.querySelectorAll('.cal-cell').forEach(div => {
    div.addEventListener('click', (e) => {
      if (e.target.closest('.event-chip')) return;
      const day = Number(div.dataset.date.split('-')[2]);
      openModal({});
      fDay.value = day;
      fStartTime.value = '09:00';
      fEndTime.value = '';
    });
  });

  // Event Click -> Edit
  document.querySelectorAll('.event-chip').forEach(div => {
    div.addEventListener('click', (e) => {
      e.stopPropagation();
      openModal({
        id: div.dataset.id,
        title: div.dataset.title,
        start: div.dataset.start,
        end: div.dataset.end || '',
        description: div.dataset.desc || '',
        canManage: div.dataset.canManage === '1'
      });
    });
  });

  // Add Today Button
  document.getElementById('addTodayBtn').onclick = () => {
    const now = new Date();
    const sameMonth = (now.getFullYear() === CAL_YEAR) && (now.getMonth() + 1 === CAL_MONTH);
    openModal({});
    fDay.value = sameMonth ? now.getDate() : 1;
    fStartTime.value = '09:00';
    fEndTime.value = '';
  };

  // Save
  saveBtn.onclick = async () => {
    const startISO = localPartsToISO(fDay.value, fStartTime.value);
    const endISO = fEndTime.value ? localPartsToISO(fDay.value, fEndTime.value) : null;
    if (!startISO) { alert('開始時刻を入力してください'); return; }

    if (endISO) {
      const startDate = new Date(startISO);
      const endDate = new Date(endISO);
      if (endDate <= startDate) {
        alert('終了時刻は開始時刻より後にしてください');
        return;
      }
    }

    const payload = {
      title: (fTitle.value || '').trim() || '無題',
      start: startISO,
      end: endISO,
      description: fDesc.value || ''
    };

    const url = editingId
      ? `/api/events/${editingId}/update/`
      : `/api/events/add/`;

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error();
      location.reload();
    } catch {
      alert('保存に失敗しました');
    }
  };

  // Delete
  delBtn.onclick = async () => {
    if (!editingId) return;
    if (!confirm('本当に削除しますか？')) return;
    try {
      const res = await fetch(`/api/events/${editingId}/delete/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken }
      });
      if (!res.ok) throw new Error();
      location.reload();
    } catch {
      alert('削除に失敗しました');
    }
  };

  // Attendance API
  async function loadAttendance(eventId) {
    try {
      const res = await fetch(`/api/events/${eventId}/attendees/`);
      if (!res.ok) return;
      const data = await res.json();
      attendCount.textContent = `${data.count}名`;
      attendList.textContent = (data.names && data.names.length)
        ? data.names.join('、 ')
        : '（まだ参加者はいません）';

      const iAm = typeof data.i_am === 'boolean' ? data.i_am : false;
      updateAttendBtn(iAm);
    } catch { }
  }

  function updateAttendBtn(isAttending) {
    if (isAttending) {
      attendBtn.textContent = '参加中 (解除)';
      attendBtn.classList.add('active'); // You might want to style .active in CSS or just rely on text
      attendBtn.style.background = 'var(--accent-success)';
    } else {
      attendBtn.textContent = '参加する';
      attendBtn.classList.remove('active');
      attendBtn.style.background = 'var(--brand-primary)';
    }
  }

  async function toggleAttendance() {
    if (!editingId) return;
    try {
      const res = await fetch(`/api/events/${editingId}/vote/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken }
      });
      if (!res.ok) { alert('更新に失敗しました'); return; }
      const data = await res.json();
      updateAttendBtn(data.attending);
      attendCount.textContent = `${data.count}名`;
      loadAttendance(editingId); // Refresh list
    } catch {
      alert('通信エラーが発生しました');
    }
  }

  attendBtn.addEventListener('click', toggleAttendance);

  // QR Code
  showQrBtn.addEventListener('click', () => {
    if (!editingId) return;
    if (!currentCanManage) {
      alert('権限がありません');
      return;
    }
    qrImage.src = `/events/${editingId}/qr/?_=${Date.now()}`;
    qrImageWrapper.style.display = 'block';
  });
</script>
{% endblock %}