{% extends "base.html" %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ year }}年{{ month }}月の予定{% endblock %}

{% block content %}
<!-- Configuration Data -->
<div id="cfg" data-year="{{ year }}" data-month="{{ month }}"
  data-can-add="{% if request.user.is_staff or request.user.role == 'officer' %}1{% else %}0{% endif %}"></div>

<!-- Calendar Container -->
<div class="cal-container">
  <!-- Header / Navigation -->
  <div class="cal-header">
    <div class="cal-nav">
      <a href="?y={{ prev_y }}&m={{ prev_m }}">← 前の月</a>
    </div>
    <h2 style="margin:0; font-size:1.2rem; color:var(--text-main);">{{ year }}年 {{ month }}月</h2>
    <div class="cal-nav">
      <a href="?y={{ next_y }}&m={{ next_m }}">次の月 →</a>
    </div>
  </div>

  <div
    style="padding:10px 20px; display:flex; justify-content:flex-end; background:var(--bg-surface); border-bottom:1px solid var(--border-subtle);">
    {% if request.user.is_staff or request.user.role == "officer" %}
    <button class="btn" id="addTodayBtn" style="font-size:0.8rem; padding:6px 12px;">+ 今日に追加</button>
    {% endif %}
  </div>

  <!-- Calendar Grid -->
  <div class="cal-grid">
    <!-- Day Headers -->
    <div class="cal-head-cell" style="color:#ef4444;">日</div>
    <div class="cal-head-cell">月</div>
    <div class="cal-head-cell">火</div>
    <div class="cal-head-cell">水</div>
    <div class="cal-head-cell">木</div>
    <div class="cal-head-cell">金</div>
    <div class="cal-head-cell" style="color:#3b82f6;">土</div>

    <!-- Days -->
    {% for week in weeks %}
    {% for day in week %}
    <div class="cal-cell {% if day == today %}today{% endif %} {% if day.month != month %}other-month{% endif %}"
      data-date="{{ day|date:'Y-m-d' }}">

      <div class="day-number">{{ day.day }}</div>

      {% for e in events_by_date|get_item:day %}
      <div class="event-chip" title="{{ e.description|default_if_none:'' }}" data-id="{{ e.id }}"
        data-title="{{ e.title|escape }}" data-start="{{ e.start|date:'c' }}"
        data-end="{% if e.end %}{{ e.end|date:'c' }}{% endif %}"
        data-desc="{{ e.description|default_if_none:''|escape }}"
        data-can-manage="{% if request.user.is_staff or request.user.role == 'officer' %}1{% else %}0{% endif %}">
        <div class="event-time">{{ e|time_range }}</div>
        <div class="event-title">{{ e.title }}</div>
      </div>
      {% endfor %}
    </div>
    {% endfor %}
    {% endfor %}
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBg">
  <div class="modal">
    <h3 id="modalTitle">予定を追加</h3>

    <div class="field">
      <label>タイトル</label>
      <input type="text" id="fTitle" placeholder="例: ミーティング" />
    </div>

    <div style="display:flex; gap:16px;">
      <div class="field" style="flex:1;">
        <label>日</label>
        <select id="fDay"></select>
      </div>
      <div class="field" style="flex:1;">
        <label>開始</label>
        <input type="time" id="fStartTime" step="300" />
      </div>
      <div class="field" style="flex:1;">
        <label>終了 (任意)</label>
        <input type="time" id="fEndTime" step="300" />
      </div>
    </div>

    <div class="field">
      <label>メモ</label>
      <textarea id="fDesc" rows="3" placeholder="詳細を入力..."></textarea>
    </div>

    <div id="attendBox" style="margin-top:20px; padding-top:10px; border-top:1px solid #ccc; display:none;">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
        <label>参加状況</label>
        <span id="attendCount" style="font-weight:bold;"></span>
      </div>
      <div id="attendList" style="font-size:0.9rem; color:#666; margin-bottom:10px;"></div>
      <button id="attendBtn" class="btn btn-outline" style="width:100%;">参加する</button>
    </div>

    <div id="qrBox" style="margin-top:20px; padding-top:10px; border-top:1px solid #ccc; display:none;">
      <button id="showQrBtn" class="btn btn-outline" style="width:100%;">QRコードを表示</button>
      <div id="qrImageWrapper" style="margin-top:10px; text-align:center; display:none;">
        <img id="qrImage" src="" alt="QR" style="max-width:200px; border-radius:8px;">
      </div>
    </div>

    <div class="modal-actions" style="margin-top:24px; display:flex; justify-content:flex-end; gap:12px;">
      <button id="deleteBtn" class="btn btn-danger" style="display:none;">削除</button>
      <button id="cancelBtn" class="btn btn-secondary">キャンセル</button>
      <button id="saveBtn" class="btn btn-primary">保存</button>
    </div>

  </div>
</div>
{% endblock %}

{% block body_end %}
<script src="{% static 'js/calendar.js' %}?v=1"></script>
{% endblock %}