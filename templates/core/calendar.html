{% extends "base.html" %}
{% load custom_filters %}

{% block title %}{{ year }}年{{ month }}月の予定{% endblock %}

{% block content %}
<style>
  .bar { display:flex; align-items:center; justify-content:space-between; margin: 8px 0 16px; }
  .bar .nav a{ color:#93c5fd; text-decoration:none; margin:0 6px; }
  .cal { width:100%; border-collapse: collapse; background:#0f172a; border-radius: 12px; overflow:hidden; }
  .cal th, .cal td { border: 1px solid #1f2937; padding: 10px; vertical-align: top; width:14.2857%; height:120px; }
  .cal th{ background:#111827; font-weight:600; color:#9ca3af; text-align:center;}
  .daynum{ font-weight:700; color:#e5e7eb; }
  .today .daynum{ background:#60a5fa; color:#0b0f1a; padding:2px 8px; border-radius:999px; }
  .other { background:#0b1220; color:#6b7280; }
  .cell{ position:relative; cursor:pointer; }
  .event{ font-size:12px; background:#1f2937; border:1px solid #374151; padding:6px 8px; border-radius:8px; margin-top:6px; }
  .event:hover{ background:#2a3648; }
  .muted{ color:#9ca3af; opacity:.85; }
  .event .time{ font-size:11px; opacity:.85; margin-bottom:2px; }
  .event .title{ font-weight:600; font-size:12px; }

  .btn{ color:#0b0f1a; background:#93c5fd; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
  .btn:hover{ filter:brightness(1.05); }
  .btn.red{ background:#fca5a5; }

  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50; }
  .modal{ width: min(520px, 92vw); background:#0f172a; border:1px solid #1f2937; border-radius:12px; padding:16px; }
  .field{ margin:10px 0;}
  .field label{ display:block; font-size:12px; color:#9ca3af; margin-bottom:4px;}
  .field input, .field textarea, .field select{ width:100%; background:#0b1220; color:#e5e7eb; border:1px solid #1f2937; border-radius:8px; padding:8px; }
  .row{ display:flex; gap:10px; }

  /* 追加: 参加ボタン */
  #attendBtn {
    margin-top: 6px;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    border: none;
    background: #60a5fa;
    color: #0b0f1a;
    font-weight: 600;
  }
  #attendBtn.active {
    background: #10b981;
    color: #fff;
  }
  #attendCount {
    font-size: 12px;
    color: #9ca3af;
    margin-top: 6px;
  }
</style>

<div id="cfg" data-year="{{ year }}" data-month="{{ month }}"></div>

<div class="bar">
  <div class="nav">
    <a href="?y={{ prev_y }}&m={{ prev_m }}">← 前の月</a>
    <a href="?y={{ next_y }}&m={{ next_m }}">次の月 →</a>
  </div>
  <h2 style="margin:0;">{{ year }}年 {{ month }}月</h2>
  <button class="btn" id="addTodayBtn">今日に追加</button>
</div>

<table class="cal">
  <thead>
    <tr>
      <th>日</th><th>月</th><th>火</th><th>水</th><th>木</th><th>金</th><th>土</th>
    </tr>
  </thead>
  <tbody>
    {% for week in weeks %}
      <tr>
        {% for day in week %}
          <td class="cell {% if day == today %}today{% endif %} {% if day.month != month %}other{% endif %}"
              data-date="{{ day|date:'Y-m-d' }}">
            <div class="daynum">{{ day.day }}</div>

            {% for e in events_by_date|get_item:day %}
              <div class="event"
                   title="{{ e.description|default_if_none:'' }}"
                   data-id="{{ e.id }}"
                   data-title="{{ e.title|escape }}"
                   data-start="{{ e.start|date:'c' }}"
                   data-end="{% if e.end %}{{ e.end|date:'c' }}{% endif %}"
                   data-desc="{{ e.description|default_if_none:''|escape }}">
                <div class="time">{{ e|time_range }}</div>
                <div class="title">{{ e.title }}</div>
              </div>
            {% empty %}
              <div class="muted" style="font-size:12px; margin-top:6px;">予定なし</div>
            {% endfor %}
          </td>
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- モーダル -->
<div class="modal-backdrop" id="modalBg">
  <div class="modal">
    <h3 id="modalTitle" style="margin:0 0 8px 0;">予定を追加</h3>

    <div class="field">
      <label>タイトル</label>
      <input type="text" id="fTitle" />
    </div>

    <div class="row">
      <div class="field" style="flex:1;">
        <label>日</label>
        <select id="fDay"></select>
      </div>
      <div class="field" style="flex:1;">
        <label>開始時刻</label>
        <input type="time" id="fStartTime" step="300" />
      </div>
      <div class="field" style="flex:1;">
        <label>終了時刻 (任意)</label>
        <input type="time" id="fEndTime" step="300" />
      </div>
    </div>

    <div class="field">
      <label>メモ</label>
      <textarea id="fDesc" rows="3"></textarea>
    </div>

    <!-- 参加ボタン -->
    <div id="attendBox" style="border-top:1px solid #1f2937; margin-top:12px; padding-top:12px; display:none;">
      <div style="font-size:12px;color:#9ca3af;margin-bottom:6px;">イベント参加</div>
      <button id="attendBtn">参加</button>
      <div id="attendCount"></div>
    </div>

    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px;">
      <button class="btn" id="saveBtn">保存</button>
      <button class="btn red" id="deleteBtn" style="display:none;">削除</button>
      <button class="btn gray" id="cancelBtn">キャンセル</button>
    </div>
  </div>
</div>

<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  const cfg = document.getElementById('cfg');
  const CAL_YEAR  = parseInt(cfg.dataset.year, 10);
  const CAL_MONTH = parseInt(cfg.dataset.month, 10);
  const DAYS_IN_MONTH = new Date(CAL_YEAR, CAL_MONTH, 0).getDate();

  const modalBg = document.getElementById('modalBg');
  const fTitle = document.getElementById('fTitle');
  const fDay = document.getElementById('fDay');
  const fStartTime = document.getElementById('fStartTime');
  const fEndTime = document.getElementById('fEndTime');
  const fDesc  = document.getElementById('fDesc');
  const saveBtn = document.getElementById('saveBtn');
  const delBtn  = document.getElementById('deleteBtn');
  const modalTitle = document.getElementById('modalTitle');

  // 参加ボタン
  const attendBox = document.getElementById('attendBox');
  const attendBtn = document.getElementById('attendBtn');
  const attendCount = document.getElementById('attendCount');

  (function initDayOptions(){
    fDay.innerHTML = '';
    for (let d = 1; d <= DAYS_IN_MONTH; d++) {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = `${d}日`;
      fDay.appendChild(opt);
    }
  })();

  const pad = (n) => String(n).padStart(2,'0');
  function localPartsToISO(day, time) {
    if (!day || !time) return null;
    const [hh, mm] = time.split(':').map(Number);
    const dt = new Date(CAL_YEAR, CAL_MONTH - 1, Number(day), hh, mm, 0);
    return dt.toISOString();
  }
  function isoToDay(iso)  { if (!iso) return ''; const d = new Date(iso); return d.getDate(); }
  function isoToTime(iso) { if (!iso) return ''; const d = new Date(iso); return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }

  let editingId = null;

  function openModal(payload) {
    modalBg.style.display = 'flex';
    if (payload && payload.id) {
      editingId = payload.id;
      modalTitle.textContent = '予定を編集';
      fTitle.value = payload.title || '';
      fDay.value = isoToDay(payload.start) || 1;
      fStartTime.value = isoToTime(payload.start) || '09:00';
      fEndTime.value   = isoToTime(payload.end)   || '';
      fDesc.value = payload.description || '';
      delBtn.style.display = 'inline-block';

      attendBox.style.display = 'block';
      loadAttendance(editingId);
    } else {
      editingId = null;
      modalTitle.textContent = '予定を追加';
      fTitle.value = '';
      fDay.value = 1;
      fStartTime.value = '09:00';
      fEndTime.value = '';
      fDesc.value = '';
      delBtn.style.display = 'none';
      attendBox.style.display = 'none';
    }
  }

  function closeModal(){ modalBg.style.display = 'none'; }
  document.getElementById('cancelBtn').onclick = closeModal;

  document.querySelectorAll('.cell').forEach(td => {
    td.addEventListener('click', (e) => {
      if (e.target.classList.contains('event')) return;
      const day = Number(td.dataset.date.split('-')[2]);
      openModal({});
      fDay.value = day;
    });
  });

  document.querySelectorAll('.event').forEach(div => {
    div.addEventListener('click', (e) => {
      e.stopPropagation();
      openModal({
        id: div.dataset.id,
        title: div.dataset.title,
        start: div.dataset.start,
        end:   div.dataset.end || '',
        description: div.dataset.desc || ''
      });
    });
  });

  document.getElementById('addTodayBtn').onclick = () => {
    const now = new Date();
    const sameMonth = (now.getFullYear() === CAL_YEAR) && (now.getMonth()+1 === CAL_MONTH);
    openModal({});
    fDay.value = sameMonth ? now.getDate() : 1;
  };

  saveBtn.onclick = async () => {
    const startISO = localPartsToISO(fDay.value, fStartTime.value);
    const endISO   = fEndTime.value ? localPartsToISO(fDay.value, fEndTime.value) : null;
    if (!startISO) { alert('開始時刻を入力してね'); return; }

    const payload = {
      title: (fTitle.value || '').trim() || '無題',
      start: startISO,
      end:   endISO,
      description: fDesc.value || ''
    };

    const url = editingId
      ? `/api/events/${editingId}/update/`
      : `/api/events/add/`;

    const res = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken},
      body: JSON.stringify(payload)
    });
    if (!res.ok) { alert('保存に失敗したかも…'); return; }
    location.reload();
  };

  delBtn.onclick = async () => {
    if (!editingId) return;
    if (!confirm('この予定を削除します。よろしい？')) return;
    const res = await fetch(`/api/events/${editingId}/delete/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken }
    });
    if (!res.ok) { alert('削除に失敗したかも…'); return; }
    location.reload();
  };

  // ===== 参加API =====
  async function loadAttendance(eventId) {
    const res = await fetch(`/api/events/${eventId}/vote/`, { method: 'POST', headers: {'X-CSRFToken': csrftoken} });
    const data = await res.json();
    updateAttendanceUI(data.attending, data.count);
  }

  async function toggleAttendance() {
    if (!editingId) return;
    const res = await fetch(`/api/events/${editingId}/vote/`, {
      method: 'POST',
      headers: {'X-CSRFToken': csrftoken}
    });
    const data = await res.json();
    updateAttendanceUI(data.attending, data.count);
  }

  function updateAttendanceUI(attending, count) {
    attendBtn.textContent = attending ? '参加中（クリックで解除）' : '参加';
    attendBtn.classList.toggle('active', attending);
    attendCount.textContent = `参加者: ${count}人`;
  }

  attendBtn.addEventListener('click', toggleAttendance);

  function renderVoteSummary(sum) {
    const c = sum?.counts || {yes:0,no:0,maybe:0};
    voteCounts.textContent = `参加 ${c.yes}｜未定 ${c.maybe}｜不参加 ${c.no}`;

    // ここを改良
    if (sum?.yes_names?.length) {
      const names = sum.yes_names.join('、 ');
      voteNames.innerHTML = `
        <div style="max-height:100px; overflow-y:auto; line-height:1.6;">
          <strong style="color:#93c5fd;">参加者一覧</strong><br>
          ${names}
        </div>
      `;
    } else {
      voteNames.textContent = '（参加者なし）';
    }

    [btnYes, btnMaybe, btnNo].forEach(b => b && (b.style.outline = 'none'));
    if (sum?.my_choice === 'yes') btnYes.style.outline = '2px solid #93c5fd';
    if (sum?.my_choice === 'maybe') btnMaybe.style.outline = '2px solid #93c5fd';
    if (sum?.my_choice === 'no') btnNo.style.outline = '2px solid #93c5fd';
  }

</script>
{% endblock %}
