# 🏗️ bado アプリケーション構成・実装解説書

このドキュメントでは、badoアプリの**フロントエンド**と**バックエンド**で、具体的にどのような処理が記述されているかを解説します。開発やデバッグ時の地図としてお使いください。

---

## 🗺️ 全体アーキテクチャ概要

badoは、**Django (Python)** がHTMLを生成し、**Vanilla JavaScript** がページ内の動的な操作（モーダル表示、非同期通信など）を担当する「**Multi-Page Application (MPA)**」構成です。

```mermaid
graph TD
    User((User)) -->|Browser| FE[Frontend (HTML/JS/CSS)]
    FE -->|HTTP Request| BE[Backend (Django)]
    BE -->|Query| DB[(Database)]
    DB -->|Result| BE
    BE -->|HTML / JSON| FE
```

---

## 🎨 Frontend (フロントエンド)

ユーザーの目に触れる部分です。主に `templates/` (HTML) と `static/` (CSS/JS) に配置されています。

### 1. HTMLテンプレート (`templates/`)
Djangoのテンプレート言語を使って、動的にHTMLを生成します。

| ファイル | 説明 |
|---|---|
| **base.html** | **全体の枠組み**。ヘッダー、ナビゲーション、PWA設定、CSS/JSの読み込みなど、全ページ共通の要素がここに書かれています。 |
| **core/calendar.html** | **カレンダー画面**。カレンダーのグリッドを描画し、イベントデータを埋め込みます。日付やイベントごとの `div` 要素にデータ属性（`data-id`, `data-title` など）を持たせて、JSで読み取れるようにしています。 |

### 2. Styles (`static/css/style.css`)
**見た目の装飾**を担当します。フレームワークを使わず、素のCSSで書かれています。

- **CSS変数**: `var(--brand-primary)` のように色やサイズを変数化し、一括管理しています。
- **ダークモード対応**: 媒体に合わせて配色を調整しています。
- **レスポンシブ**: スマホとPCでレイアウトが崩れないよう調整しています。

### 3. JavaScript (`static/js/calendar.js`)
**画面上の動き**を担当します。ページ遷移を伴わない操作（イベント作成、出欠ボタンなど）はここで行います。

- **DOM操作**: HTML要素を取得し、クリックイベントなどを監視します。
- **モーダル制御**: 「予定を追加」ボタンが押されたら、入力フォームを表示します。既に登録済みのイベントをクリックした場合は、そのデータ（タイトルや時間）をフォームに入力済み状態で表示します。
- **Ajax通信 (Fetch API)**: バックエンドのAPIと通信し、画面をリロードせずにデータを送受信します。
    - 例：「参加する」ボタン → サーバーに「参加」リクエスト送信 → 最新の参加人数を受信 → 画面の数字を更新。

---

## ⚙️ Backend (バックエンド)

サーバー側の処理です。データ処理、データベース操作、セキュリティなどを担当します。主に `core/` ディレクトリにあります。

### 1. データモデル (`core/models.py`)
**データの設計図**です。データベースにどのようなテーブルを作るかを定義します。

- **User**: ユーザー情報。役職 (`role`) という独自の項目を追加し、一般・運営・管理者を区別しています。
- **Event**: イベント情報（タイトル、日時、説明、QR用トークンなど）。
- **EventAttendance**: 「誰がどのイベントに参加するか」という中間テーブル。

### 2. ビュー (`core/views.py`)
**司令塔**です。ブラウザからのリクエストを受け取り、適切な処理をしてレスポンスを返します。大きく分けて2種類の処理があります。

#### A. ページを表示するためのビュー (HTMLを返す)
- `calendar_view`: データベースから指定月のアクティブなイベントを取得し、カレンダーの形にデータを整形して `calendar.html` を返します。
- `magazines_list`: アップロードされた月刊誌の一覧を表示します。

#### B. APIビュー (JSONを返す)
JavaScriptからのリクエストに応答するための、データ専用の窓口です。
- `event_add` / `event_update`: イベント情報の保存処理。
- `event_vote`: 「参加/キャンセル」の切り替え処理。
- `event_qr`: QRコード画像を生成して返す処理。

### 3. URL設定 (`core/urls.py` / `circle_app/urls.py`)
**受付窓口**です。ブラウザからのURL（例: `/calendar/`）を見て、どのビュー関数につなぐかを振り分けます。

---

## 🔄 具体的な処理の流れ (例)

### ケース1: イベントを作成する

1. **Frontend**: ユーザーがカレンダーの日付をクリック。
2. **Frontend (JS)**: `openModal()` 関数が動き、モーダルウィンドウを表示。
3. **Frontend**: ユーザーが内容を入力して「保存」をクリック。
4. **Frontend (JS)**: 入力内容をJSONデータにまとめ、`/api/events/add/` へ送信。
5. **Backend (View)**: `views.event_add` がデータを受け取り、バリデーション（チェック）を行う。
6. **Backend (Model)**: `Event` モデルを使ってデータベースに保存。
7. **Backend**: 成功メッセージを返す。
8. **Frontend (JS)**: 成功を受け取り、ページをリロードして新しい予定を表示する。

### ケース2: 参加ボタンを押す

1. **Frontend**: ユーザーがイベントをクリックして詳細を開く。
2. **Frontend (JS)**: `loadAttendance()` が走り、現在の参加者リストをサーバーに問い合わせて表示。
3. **Frontend**: ユーザーが「参加する」ボタンをクリック。
4. **Frontend (JS)**: `/api/events/<id>/vote/` へリクエスト送信。
5. **Backend (View)**: `views.event_vote` がリクエストを受け取る。
    - 既に「参加」なら削除、「不参加」なら作成（トグル処理）。
6. **Backend**: 最新の参加人数と、自分が参加状態かどうかをJSONで返す。
7. **Frontend (JS)**: 返ってきたデータをもとに、ボタンの色と参加人数表示を更新（画面リロードなし）。
